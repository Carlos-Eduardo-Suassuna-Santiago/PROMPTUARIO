{% extends "base.html" %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}
        Editar Prontuário
    {% else %}
        Criar Prontuário
    {% endif %}
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/medical_record.css' %}">
    <style>
        .editor-section {
            margin-bottom: 2rem;
        }

        .editor-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .form-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .ql-container {
            border-color: #e2e8f0;
        }

        .ql-editor {
            background-color: white;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            {% if form.instance.pk %}
                Editar Prontuário Médico
            {% else %}
                Criar Novo Prontuário Médico
            {% endif %}
        </h1>
    </div>

    {% if appointment %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                Consulta #{{ appointment.pk }} – {{ appointment.scheduled_date|date:"d/m/Y" }}
                às {{ appointment.scheduled_time|time:"H:i" }}
            </h5>
        </div>
        <div class="card-body">
            <p><strong>Paciente:</strong> {{ patient.user.get_full_name }}</p>
            <p><strong>Médico:</strong> {{ user.get_full_name }}</p> 
            <p><strong>Queixa principal informada na consulta:</strong> {{ appointment.reason|default:"N/A" }}</p>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <strong>Atenção:</strong> Este prontuário não está vinculado a uma consulta específica.
    </div>
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" id="medical-record-form" novalidate>
                {% csrf_token %}

                <!-- Seção: Queixa Principal -->
                <div class="form-section">
                    <h4 class="editor-section-title">
                        <i class="fas fa-stethoscope"></i> Queixa Principal
                    </h4>
                    <div class="editor-container">
                        <label class="editor-label required">Relato do Médico</label>
                        <div id="chief-complaint-editor" data-editor="rich"></div>
                        <textarea name="chief_complaint" style="display: none;"></textarea>
                        {% if form.chief_complaint.errors %}
                            <div class="text-danger mt-2">{{ form.chief_complaint.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Seção: Exame Clínico -->
                <div class="form-section">
                    <h4 class="editor-section-title">
                        <i class="fas fa-heartbeat"></i> Exame Clínico
                    </h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="editor-container">
                                <label class="editor-label">Sintomas</label>
                                <div id="symptoms-editor" data-editor="rich"></div>
                                <textarea name="symptoms" style="display: none;"></textarea>
                                {% if form.symptoms.errors %}
                                    <div class="text-danger mt-2">{{ form.symptoms.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="editor-container">
                                <label class="editor-label">Exame Físico</label>
                                <div id="physical-examination-editor" data-editor="rich"></div>
                                <textarea name="physical_examination" style="display: none;"></textarea>
                                {% if form.physical_examination.errors %}
                                    <div class="text-danger mt-2">{{ form.physical_examination.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seção: Diagnóstico -->
                <div class="form-section">
                    <h4 class="editor-section-title">
                        <i class="fas fa-diagnoses"></i> Diagnóstico
                    </h4>
                    <div class="editor-container">
                        <label class="editor-label">Diagnóstico (CID-10, se aplicável)</label>
                        <div id="diagnosis-editor" data-editor="rich"></div>
                        <textarea name="diagnosis" style="display: none;"></textarea>
                        {% if form.diagnosis.errors %}
                            <div class="text-danger mt-2">{{ form.diagnosis.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Seção: Tratamento -->
                <div class="form-section">
                    <h4 class="editor-section-title">
                        <i class="fas fa-pills"></i> Plano de Tratamento
                    </h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="editor-container">
                                <label class="editor-label">Plano de Tratamento</label>
                                <div id="treatment-plan-editor" data-editor="rich"></div>
                                <textarea name="treatment_plan" style="display: none;"></textarea>
                                {% if form.treatment_plan.errors %}
                                    <div class="text-danger mt-2">{{ form.treatment_plan.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="editor-container">
                                <label class="editor-label">Observações Adicionais</label>
                                <div id="observations-editor" data-editor="rich"></div>
                                <textarea name="observations" style="display: none;"></textarea>
                                {% if form.observations.errors %}
                                    <div class="text-danger mt-2">{{ form.observations.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save"></i>
                        {% if form.instance.pk %}
                            Salvar Alterações
                        {% else %}
                            Criar Prontuário
                        {% endif %}
                    </button>

                    <a href="{% url 'patients:patient_detail' pk=patient.pk %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mapear campos do formulário para os editores
    const fieldMappings = {
        'chief-complaint-editor': 'chief_complaint',
        'symptoms-editor': 'symptoms',
        'physical-examination-editor': 'physical_examination',
        'diagnosis-editor': 'diagnosis',
        'treatment-plan-editor': 'treatment_plan',
        'observations-editor': 'observations'
    };

    // Inicializar cada editor com dados existentes
    Object.entries(fieldMappings).forEach(([editorId, fieldName]) => {
        const editor = document.getElementById(editorId);
        const textarea = document.querySelector(`textarea[name="${fieldName}"]`);
        
        if (editor && textarea) {
            // Aguardar Quill ser inicializado
            setTimeout(() => {
                const quill = window[`quill_${editorId}`];
                if (quill && textarea.value) {
                    try {
                        const delta = JSON.parse(textarea.value);
                        quill.setContents(delta);
                    } catch (e) {
                        quill.setText(textarea.value);
                    }
                }
            }, 500);
        }
    });

    // Sincronizar dados dos editores para os textareas antes do submit
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            Object.entries(fieldMappings).forEach(([editorId, fieldName]) => {
                const editor = document.getElementById(editorId);
                const textarea = document.querySelector(`textarea[name="${fieldName}"]`);
                
                if (editor && textarea) {
                    const quill = window[`quill_${editorId}`];
                    if (quill) {
                        // Salvar conteúdo como delta (JSON)
                        textarea.value = JSON.stringify(quill.getContents());
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}
